import React, { useEffect, useState } from "react";
import { addresim, auht, storage, update, updatess } from './firebase';
import { useDispatch, useSelector } from 'react-redux';
import { Button, imageListClasses } from "@mui/material";
import CreateIcon from '@mui/icons-material/Create';
import CircularProgress from '@mui/material/CircularProgress';
import Box from '@mui/material/Box';

import { ref, getDownloadURL, uploadBytesResumable } from "firebase/storage";
import { loginol } from "./store/auht";
import './Profil.css'
import TextField from '@mui/material/TextField';
import Dialog from '@mui/material/Dialog';
import DialogActions from '@mui/material/DialogActions';
import DialogContent from '@mui/material/DialogContent';
import DialogContentText from '@mui/material/DialogContentText';
import DialogTitle from '@mui/material/DialogTitle';
import kullanici from "./store/kullanici";




function Profil() {
  
  const {kullanici} = useSelector(state => {return state.kullanici})
 
  const [imgUrl, setImgUrl] = useState( 'https://rajueditor.com/wp-content/uploads/2023/10/zoom-profil-fotograflari-1024x1024.jpg');
  const [displayName, setdisplayName] = useState('');
  const [open, setOpen] = useState(false);
  const [loadingGoster, setLoadingGoster] = useState(false);
  const [degis,setDegis] = useState()




  useEffect(() => {
    if (kullanici[0]) {
      setImgUrl(kullanici[0].imgUrl); 
      setdisplayName(kullanici[0].displayName);
     

      
      
     
    }
  }, [kullanici]);
 

 


  const handleClose = () => {
    setOpen(false);
  }; 
  const handleClickOpen = () => {
    setOpen(true);


  };
  const ekle = async ()=>{
   
    await addresim({
      displayName:displayName,
      imgUrl:imgUrl,
      uid:auht.currentUser.uid
    }) 
   
      
        
  
  }


  const Guncelle = async (e)=> {
    e.preventDefault();
    
    
    await updatess (kullanici[0].id,{
      displayName:displayName,
      imgUrl:imgUrl,
     uid:auht.currentUser.uid
    
    })
   


    console.log(auht.currentUser)
    handleClose()
 

  }


  const guncelle = async (event, kullaniciId) => {
  console.log(imgUrl)
  console.log(kullanici)
    console.log(event);
    const file = event.target.files[0];
    

    if (!file) return;
    const storageRef = ref(storage, `files/${file.name}`);
    setLoadingGoster(true);
    const uploadTask = uploadBytesResumable(storageRef, file);
    uploadTask.on("state_changed",
      (snapshot) => {
      },
      (error) => {
        alert(error);
      },
      ()   => {
        getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL)    =>  {
          setImgUrl(downloadURL);
          
          await updatess (kullaniciId,{
            displayName:displayName,
            
            imgUrl:downloadURL,
           uid:auht.currentUser.uid
          
          })
       
          
          
       
          setDegis(kullaniciId);
          setTimeout(() =>setLoadingGoster(false), 1000 );
          console.log(imgUrl)
        });
      }
    );

  
 
  }

  const ekleVeyaGuncelle = (e) => {
    if(displayName) {
      // güncelleme
      guncelle(e, kullanici[0].id);
    } else {
      // eleme
      ekle();
    }
  }
 







  return (
    <div>
    <div className="bas">
    <div >

      <div className="aa"></div>
      <div className="hrs"></div>
      

<div>

      <form className='form'>
        <div onChange={(e)=> setDegis(e.target.value)} value={degis}>
             <input type='file' id='files' style={{ display: 'none' }} onChange={ekleVeyaGuncelle}  />
        </div>
    
      </form>

        <>
          <label for='files' style={{position:  "relative"}}>
            <img src={imgUrl} className="resim" alt='uploaded file' height={100} width={100} />
            
            {
              loadingGoster && <div style={{ position: "absolute", bottom: 0, top:0, left: 0, right: 0, zIndex: 10 }}> 
                  <div style={{backgroundColor: "white", opacity: 0.5, marginLeft: "51px", marginTop: "40px", borderRadius: "10px", width: "30px", height: "30px" }}>
                  <CircularProgress size={20} style={{margin: "5px"}} />
                  </div>
              </div>
            }
          </label>
          <div>
        <label className="input" value={displayName} onChange={event => setdisplayName(event.target.value)}>

          {displayName}
        </label>
        < CreateIcon onClick={handleClickOpen} />
      </div>
        </>
      </div>
      <div>
        <Dialog open={open} onClose={handleClose}>
          <DialogTitle>Kitap Güncelle</DialogTitle>
          <DialogContent>
            <DialogContentText>
              Kitap bilgilarini güncelleyiniz
            </DialogContentText>
            <TextField
              autoFocus
              margin="dense"
              onChange={e => setdisplayName(e.target.value)}
              label="Kitap İsmi"
              value={displayName}
              fullWidth
              variant="standard"
            />


          </DialogContent>
          <DialogActions>
            <Button onClick={handleClose}>Kapat</Button>

    
 <Button onClick={ (e) => Guncelle (e)}>Güncelle</Button>

          </DialogActions>
        </Dialog>
      </div>

     

    </div>
    <div>
    </div>
      
    </div>
   
   
  </div>

  );

}

export default Profil;































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































